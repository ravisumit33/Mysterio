test: "[ ! -f /usr/bin/psql ]"  # Check if PostgreSQL is not already installed

commands:
  01_update_yum:
    command: "sudo yum update -y"
  02_enable_postgresql14:
    command: "sudo amazon-linux-extras enable postgresql14"
  03_install_postgresql_devel:
    command: "sudo yum install postgresql-devel -y"

## Below commands are used for single-instance local postgres
  04_install_postgresql_server:
    command: "sudo yum install postgresql-server -y"
  05_init_db:
    command: "sudo postgresql-setup initdb"
  06_start_service_and_enable_at_boot:
    command: |
      sudo systemctl start postgresql
      sudo systemctl enable postgresql
  07_change_authentication_method:
    command: |
      sed -i "/^host\s*all\s*all\s*.*$/ s/ident/scram-sha-256/" /var/lib/pgsql/data/pg_hba.conf
      sudo systemctl restart postgresql
  08_create_user_and_db:
    command: |
      SECRETS_JSON=$(aws secretsmanager get-secret-value --secret-id "mysterio" --region "ap-south-1" --query "SecretString")
      DB_NAME=$(echo "$SECRETS_JSON" | jq -r '.DB_NAME')
      DB_PASS=$(echo "$SECRETS_JSON" | jq -r '.DB_PASSWORD')
      DB_USER=$(echo "$SECRETS_JSON" | jq -r '.DB_USER')
      sudo -u postgres psql -c "CREATE DATABASE '${DB_NAME}';"
      sudo -u postgres psql -c "CREATE USER '${DB_USER}' WITH PASSWORD '${DB_PASSWORD}';"
      sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE '${DB_NAME}' TO '${DB_USER}';"
